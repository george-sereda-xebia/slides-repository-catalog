name: Build Catalog

on:
  # Manual trigger
  workflow_dispatch:

  # Scheduled run: every hour from 6 AM to 8 PM UTC (skip nighttime)
  schedule:
    - cron: '0 6-20 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t slides-catalog-builder .

      - name: Run catalog builder
        env:
          SOURCE_MODE: ${{ secrets.SOURCE_MODE || 'local' }}
          # Local mode
          LOCAL_ASSETS_PATH: ${{ secrets.LOCAL_ASSETS_PATH || 'Reusable_Assets' }}
          # SharePoint mode
          TENANT_ID: ${{ secrets.TENANT_ID }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          SHAREPOINT_HOSTNAME: ${{ secrets.SHAREPOINT_HOSTNAME }}
          SITE_PATH: ${{ secrets.SITE_PATH }}
          ROOT_FOLDER_PATH: ${{ secrets.ROOT_FOLDER_PATH }}
        run: |
          docker run --rm \
            -e SOURCE_MODE="${SOURCE_MODE}" \
            -e LOCAL_ASSETS_PATH="${LOCAL_ASSETS_PATH}" \
            -e TENANT_ID="${TENANT_ID}" \
            -e CLIENT_ID="${CLIENT_ID}" \
            -e CLIENT_SECRET="${CLIENT_SECRET}" \
            -e SHAREPOINT_HOSTNAME="${SHAREPOINT_HOSTNAME}" \
            -e SITE_PATH="${SITE_PATH}" \
            -e ROOT_FOLDER_PATH="${ROOT_FOLDER_PATH}" \
            -v ${{ github.workspace }}/site:/app/site \
            -v ${{ github.workspace }}/Reusable_Assets:/app/Reusable_Assets \
            slides-catalog-builder

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          force_orphan: true
